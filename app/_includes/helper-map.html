
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.3.0/css/foundation.min.css"> -->

<div id="helper-map-contents">
  <div class="row">
    <div class="columns">
      <div class="sub-head">Mapathon Helper</div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="small-12 medium-offset-1 medium-10 large-offset-1 large-10">
      <!-- geo search https://github.com/smeijer/leaflet-geosearch -->
      <div id="map" style="height:480px"></div>
    </div>
  </div>

  <br>

  <div class="row">
    <div class="small-12 medium-offset-1 medium-10 large-offset-2 large-8">
        <div class="row">
          <div class="small-3 columns">
            <label for="right-label" class="text-right middle">Filter by a language</label>
          </div>
          <div class="small-9 columns">
            <select id="language-filter" style="width:auto;">
              <option value="all">All</option>
              <!-- ... -->
            </select>
          </div>
        </div>
    </div>
  </div>

  <br>

  <div id="contact-cards" class="row small-up-2 medium-up-3 large-up-4" >
    <!-- ... -->
  </div>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/what-input/4.0.6/what-input.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.3.0/js/foundation.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script src="https://use.fontawesome.com/eb154e6e77.js"></script>

  <script>
    $(document).foundation();
    $(document).ready(function() {
      var languageLookup = {
          "aa": "Afar",
          "ab": "Abkhazian",
          "ae": "Avestan",
          "af": "Afrikaans",
          "ak": "Akan",
          "am": "Amharic",
          "an": "Aragonese",
          "ar": "Arabic",
          "as": "Assamese",
          "av": "Avaric",
          "ay": "Aymara",
          "az": "Azerbaijani",
          "ba": "Bashkir",
          "be": "Belarusian",
          "bg": "Bulgarian",
          "bh": "Bihari languages",
          "bi": "Bislama",
          "bm": "Bambara",
          "bn": "Bengali",
          "bo": "Tibetan",
          "br": "Breton",
          "bs": "Bosnian",
          "ca": "Catalan/ Valencian",
          "ce": "Chechen",
          "ch": "Chamorro",
          "co": "Corsican",
          "cr": "Cree",
          "cs": "Czech",
          "cu": "Church Slavic/ Old Slavonic/ Church Slavonic/ Old Bulgarian/ Old Church Slavonic",
          "cv": "Chuvash",
          "cy": "Welsh",
          "da": "Danish",
          "de": "German",
          "dv": "Divehi/ Dhivehi/ Maldivian",
          "dz": "Dzongkha",
          "ee": "Ewe",
          "el": "Greek",
          "en": "English",
          "eo": "Esperanto",
          "es": "Spanish/ Castilian",
          "et": "Estonian",
          "eu": "Basque",
          "fa": "Persian",
          "ff": "Fulah",
          "fi": "Finnish",
          "fj": "Fijian",
          "fo": "Faroese",
          "fr": "French",
          "fy": "Western Frisian",
          "ga": "Irish",
          "gd": "Gaelic/ Scottish Gaelic",
          "gl": "Galician",
          "gn": "Guarani",
          "gu": "Gujarati",
          "gv": "Manx",
          "ha": "Hausa",
          "he": "Hebrew",
          "hi": "Hindi",
          "ho": "Hiri Motu",
          "hr": "Croatian",
          "ht": "Haitian/ Haitian Creole",
          "hu": "Hungarian",
          "hy": "Armenian",
          "hz": "Herero",
          "ia": "Interlingua (International Auxiliary Language Association)",
          "id": "Indonesian",
          "ie": "Interlingue/ Occidental",
          "ig": "Igbo",
          "ii": "Sichuan Yi/ Nuosu",
          "ik": "Inupiaq",
          "io": "Ido",
          "is": "Icelandic",
          "it": "Italian",
          "iu": "Inuktitut",
          "ja": "Japanese",
          "jv": "Javanese",
          "ka": "Georgian",
          "kg": "Kongo",
          "ki": "Kikuyu/ Gikuyu",
          "kj": "Kuanyama/ Kwanyama",
          "kk": "Kazakh",
          "kl": "Kalaallisut/ Greenlandic",
          "km": "Central Khmer",
          "kn": "Kannada",
          "ko": "Korean",
          "kr": "Kanuri",
          "ks": "Kashmiri",
          "ku": "Kurdish",
          "kv": "Komi",
          "kw": "Cornish",
          "ky": "Kirghiz/ Kyrgyz",
          "la": "Latin",
          "lb": "Luxembourgish/ Letzeburgesch",
          "lg": "Ganda",
          "li": "Limburgan/ Limburger/ Limburgish",
          "ln": "Lingala",
          "lo": "Lao",
          "lt": "Lithuanian",
          "lu": "Luba-Katanga",
          "lv": "Latvian",
          "mg": "Malagasy",
          "mh": "Marshallese",
          "mi": "Maori",
          "mk": "Macedonian",
          "ml": "Malayalam",
          "mn": "Mongolian",
          "mr": "Marathi",
          "ms": "Malay",
          "mt": "Maltese",
          "my": "Burmese",
          "na": "Nauru",
          "nb": "Bokmål, Norwegian/ Norwegian Bokmål",
          "nd": "Ndebele, North/ North Ndebele",
          "ne": "Nepali",
          "ng": "Ndonga",
          "nl": "Dutch/ Flemish",
          "nn": "Norwegian Nynorsk/ Nynorsk, Norwegian",
          "no": "Norwegian",
          "nr": "Ndebele, South/ South Ndebele",
          "nv": "Navajo/ Navaho",
          "ny": "Chichewa/ Chewa/ Nyanja",
          "oc": "Occitan (post 1500)/ Provençal",
          "oj": "Ojibwa",
          "om": "Oromo",
          "or": "Oriya",
          "os": "Ossetian/ Ossetic",
          "pa": "Panjabi/ Punjabi",
          "pi": "Pali",
          "pl": "Polish",
          "ps": "Pushto/ Pashto",
          "pt": "Portuguese",
          "qu": "Quechua",
          "rm": "Romansh",
          "rn": "Rundi",
          "ro": "Romanian/ Moldavian/ Moldovan",
          "ru": "Russian",
          "rw": "Kinyarwanda",
          "sa": "Sanskrit",
          "sc": "Sardinian",
          "sd": "Sindhi",
          "se": "Northern Sami",
          "sg": "Sango",
          "si": "Sinhala/ Sinhalese",
          "sk": "Slovak",
          "sl": "Slovenian",
          "sm": "Samoan",
          "sn": "Shona",
          "so": "Somali",
          "sq": "Albanian",
          "sr": "Serbian",
          "ss": "Swati",
          "st": "Sotho, Southern",
          "su": "Sundanese",
          "sv": "Swedish",
          "sw": "Swahili",
          "ta": "Tamil",
          "te": "Telugu",
          "tg": "Tajik",
          "th": "Thai",
          "ti": "Tigrinya",
          "tk": "Turkmen",
          "tl": "Tagalog",
          "tn": "Tswana",
          "to": "Tonga (Tonga Islands)",
          "tr": "Turkish",
          "ts": "Tsonga",
          "tt": "Tatar",
          "tw": "Twi",
          "ty": "Tahitian",
          "ug": "Uighur/ Uyghur",
          "uk": "Ukrainian",
          "ur": "Urdu",
          "uz": "Uzbek",
          "ve": "Venda",
          "vi": "Vietnamese",
          "vo": "Volapük",
          "wa": "Walloon",
          "wo": "Wolof",
          "xh": "Xhosa",
          "yi": "Yiddish",
          "yo": "Yoruba",
          "za": "Zhuang/ Chuang",
          "zh": "Chinese",
          "zu": "Zulu"
        }
      var contactIconHtml = function(type) {
        switch(type) {
          case 'twitter':
            return '<i class="fa fa-fw fa-twitter" aria-hidden="true"></i>';
            break;
          case 'email':
            return '<i class="fa fa-fw fa-envelope" aria-hidden="true"></i>';
            break;
          case 'osm':
            return '<i class="fa fa-fw fa-user-circle" aria-hidden="true"></i>';
            break;
          case 'phone':
            return '<i class="fa fa-fw fa-phone" aria-hidden="true"></i>';
            break;
          default:
            return '<i class="fa fa-fw fa-address-card" aria-hidden="true"></i>';
        }
      }

      // get the contact data from the google spreadhsheet
      var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1qfg5ECN7IMYk8ftCzYL4tTZChYIDVXbFdhnXtwpRzqI/pub?gid=0&single=true&output=csv';
      function init() {
        Tabletop.init( { key: publicSpreadsheetUrl,
                         callback: showInfo,
                         simpleSheet: true } )
      }


      function showInfo(data, tabletop) {
        validMarkers = [];
        allLanguages = [];
        // add a LatLng object and an ID to each item in the dataset
        data.forEach(function(d, i) {
          var coordinates = d.coordinates.replace(/\s/g,'').split('/');
          // TODO: improve the process for confirming a valid latLng
          if(coordinates.length == 2) {
            coordinates[0] = parseFloat(coordinates[0])
            coordinates[1] = parseFloat(coordinates[1])
            if(!isNaN(coordinates[0]) && !isNaN(coordinates[1])) {
              d.LatLng = new L.LatLng(parseFloat(coordinates[0]), parseFloat(coordinates[1]));
              d.id = i;
              d.languages = d.languages.replace(/\s/g,'').split(';');
              validMarkers.push(d)
              $.each(d.languages, function(i,lang){
                if($.inArray(lang, allLanguages) == -1) { allLanguages.push(lang); }
              });
            }
          }
        });

        allLanguages.sort();
        $.each(allLanguages, function(i, lang) {
          var html = '<option value="' + lang + '">' + languageLookup[lang] + '</option>';
          $('#language-filter').append(html);
        });



        map = L.map('map', {minZoom: 2});

        map.setView([0, 0], 2);

        // L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        //     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        // }).addTo(map);

        L.tileLayer('http://api.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RhdGVvZnNhdGVsbGl0ZSIsImEiOiJlZTM5ODI5NGYwZWM2MjRlZmEyNzEyMWRjZWJlY2FhZiJ9.omsA8QDSKggbxiJjumiA_w.', {
        	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // initialize the SVG layer for D3 drawn markers
        L.svg().addTo(map);
        // pick up the SVG from the map object
        var svg = d3.select('#map').select('svg');
        markersGroup = svg.append('g').attr('id', 'markers').attr('class', 'leaflet-zoom-hide');

        // add markers to the map for each contact
        mappedContacts = d3.select('svg #markers').selectAll('text').data(validMarkers)
          .enter().append('text')
          .attr('class', 'mapmarker')
          .text('\uf276')
          .attr('font-family', 'FontAwesome')
          .attr('class', function(d) { return 'help_' + d.help_type; });

        // when map view changes adjust the locations of the svg circles
        updatemarker = function() {
          mappedContacts.attr('x',function(d) { return map.latLngToLayerPoint(d.LatLng).x; });
          mappedContacts.attr('y',function(d) { return map.latLngToLayerPoint(d.LatLng).y; });
        }
        // set the starting locations of the markers
        updatemarker();

        filter = function(){

          var filteredData = validMarkers;

          var bounds = map.getBounds();
          filteredData = filteredData.filter(function(d) {
            return bounds.contains(d.LatLng);
          });

          var language = $('#language-filter').find(':selected').val();
          if(language !== 'all') {
            filteredData = filteredData.filter(function(d) {
              return ($.inArray(language, d.languages) !== -1);
            });
          }
          toggleMarkerVis(language);
          drawCards(filteredData);
        }

        drawCards = function(list) {
          var contactCards = d3.select('#contact-cards').selectAll('div.column').data(list, function(d) { return d.id; });
          // no UPDATE
          // ENTER
          contactCards.enter().append('div')
              .attr('class', 'column')
              .html(function(d) {
                  var lang = [];
                  $.each(d.languages, function(i, item){ lang.push(languageLookup[item]); });
                  var html = '<div class="card" data-equalizer-watch>' +
                        '<div class="card-section">' +
                          '<h5>' + d.name + '</h5>' +
                          '<p><small><span class="help_' + d.help_type + '">' + d.help_type + '</span><br>' +
                          contactIconHtml(d.primary_type) + ' ' + d.primary_contact  + '</br>' +
                          lang.join('; ') +
                          '</small></p>' +
                        '</div>' +
                      '</div>';
                  return html;
                })
          // EXIT
          contactCards.exit().remove();
        }

        toggleMarkerVis = function(language) {
          mappedContacts.each(function(d) {
            if( ($.inArray(language, d.languages) !== -1) || (language == 'all') ){
              d3.select(this).classed('no-language', false);
            } else {
              d3.select(this).classed('no-language', true);
            }
          });
        }


      // when map view changes check what markers are visible in the extent
      map.on('load moveend zoomend viewreset', filter);
      // filter();

      // when map view changes adjust the locations of the markers
      map.on('zoom move viewreset', updatemarker);

      $('#language-filter').change(function(){
        filter();
      })

      filter();


      // d3.select('#contact-cards').property('data-equalizer', true).attr('data-equalize-by-row','true')
      // new Foundation.Equalizer($('#contact-cards'));


      }

      // start things up
      window.addEventListener('DOMContentLoaded', init)
    });
  </script>

</div>
